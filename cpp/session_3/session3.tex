% !TEX encoding = UTF-8 Unicode
% -*- coding: UTF-8; -*-
% vim: set fenc=utf-8
\documentclass[svgnames]{beamer}
\setlength{\tabcolsep}{3em}
\usetheme[pageofpages=of,% String used between the current page and the
                         % total page count.
          titleline=true,
          alternativetitlepage=true% Use the fancy title page.
          ]{Torino}
\usecolortheme{metascale}
\usepackage{listings}

\ifxetex
  \usepackage{fontspec}
  \defaultfontfeatures{Mapping=tex-text}
  \setsansfont[ItalicFont={GillSansMTPro-BookItalic}]{GillSansMTPro-Book}
  \setmonofont{Inconsolata}
  \newcommand{\codefont}{\ttfamily}
\else
  \usepackage[utf8x]{inputenc}
  %\usepackage[nott]{inconsolata}
  %\newcommand{\codefont}{\fontfamily{fi4}\selectfont}
  \usepackage{inconsolata}
  \newcommand{\codefont}{\ttfamily}
\fi
\usepackage{graphicx}
\usepackage{color}
%\usepackage{multicol}
%\usepackage{array}
%\usepackage{colortbl}
\usepackage[frenchb]{babel}
%\usepackage{pgfplots}
%\usepackage{standalone}
\usepackage{relsize}

% setup tikz
%% \usepackage{tikz}
%% \usetikzlibrary{calc,trees,positioning,arrows,chains,shapes.geometric,%
%% decorations.pathreplacing,decorations.pathmorphing,shapes,%
%% matrix,shapes.symbols,plotmarks,decorations.markings,shadows,%
%% snakes,backgrounds}
\def\print#1{\pgfmathparse{#1}\pgfmathresult}
\def\colx{Blue!40}
\def\coly{Blue!20}
\def\colz{white}

\def\C++{\textup{C}\nolinebreak[4]\hspace{-.05em}\raisebox{.4ex}{\relsize{-3}{\textbf{++}}}}

% vertical align box
\newcommand*{\vcenteredhbox}[1]{\begingroup
\setbox0=\hbox{#1}\parbox{\wd0}{\box0}\endgroup}

\lstdefinestyle{customcpp}{language=C++,
        basicstyle=\footnotesize\codefont,
        tabsize=2,
        numberstyle=\footnotesize,
        showstringspaces=false,
        %columns=fullflexible,
        keywordstyle=\color[rgb]{0.64,0.13,0.11},
        identifierstyle=,
        commentstyle=\color[rgb]{0.27,0.27,0.28},
        stringstyle=\color[rgb]{0.82,0.16,0.14},
        }

\definecolor{hlcolor}{rgb}{0.88,0.88,0.88}
\pgfdeclareimage[interpolate=true,width=9cm]{move}{move}

\NoAutoSpaceBeforeFDP

\title{Programmation C++ Avancée}
\subtitle{Session 3 -- Gestions des Ressources}
\author{Joel Falcou \and Guillaume Melquiond}
\institute{Laboratoire de Recherche en Informatique}
\date{}

\subject{Computer Science}

\begin{document}
\include{sourcecode}

\begin{frame}[plain]
\titlepage
\end{frame}
\setcounter{framenumber}{0}

\frame
{
  \frametitle{Principe de RAII}
  \begin{block}{Objectifs}
  \begin{itemize}\footnotesize
  \item Assurer la sûreté de la gestion des ressources
  \item Minimiser la gestion manuelle de la mémoire
  \item Simplifier la gestion des exceptions
  \item Assure une sémantique de valeur
  \end{itemize}
  \end{block}
  
  \begin{center}
  \textbf{R}esource \textbf{A}cquisition \textbf{I}s \textbf{I}nitialisation
  \end{center}

  \begin{block}{Mise en \oe{uvre}}
  \begin{itemize}\footnotesize
  \item Constructeurs = prise de ressource
  \item Destructeur = libération de ressource
  \item Gestion de la ressource au niveau du bloc
  \end{itemize}
  \end{block}
}

\frame
{
  \frametitle{Principe de RAII}
  \begin{block}{Conséquences}
  \begin{itemize}
  \item Certains membres deviennent spéciaux
  \item allouer implique libérer
  \item Couplage entre déstructeur et constructeurs
  \end{itemize}
  \end{block}

  \begin{block}{La Règle des Trois}
  Une classe se doit de disposer d'un constructeur par défaut, de copie,
  d'un destructeur et d'un opérateur d'affection dés que l'un de ces membres 
  a une déinition non triviale.
  \end{block}
}

\frame
{
  \frametitle{La régle des 3 en action}
  \only<1>{\sourcecodecpplines{code/rule3.cpp}{1}{15}}
  \only<2>{\sourcecodecpplines{code/rule3.cpp}{16}{28}}  
}

\frame
{
  \frametitle{Retour sur la sémantique de transfert}
  \begin{center}\pgfuseimage{move}\end{center}
  \begin{block}{Conséquences}
  \begin{itemize}
  \item \cpptext{A::A(A\&\&)} et \cpptext{operator=(A\&\&)} deviennent spéciaux
  \item Complexité accrue
  \end{itemize}  
  \end{block}{}
}

\frame
{
  \frametitle{Copie, Transfert, etc ...}
  \begin{block}{Régles d'apparitions des membres spéciaux}
  \begin{itemize}
  \item  Si un constructeur non-trivial est déclaré, le constructeur par défaut n'est pas généré
   \item Si un destructeur virtuel est déclaré, le destructeur par défaut n'est pas déclaré
   \item Si un constructeur/assignment par rvalue est déclaré alors:
  \begin{itemize}
      \item Pas de constructeur par copie par défaut
      \item Pas d'assignment par défaut
  \end{itemize}
   \item  Si un constructeur par copie, par rvalue, un destructeur ou un assignement est défini
  \begin{itemize}
    \item Pas de constructuer par rvalue par défaut
    \item Pas d'assignement par rvalue par défaut
  \end{itemize}
  \end{itemize}
  \end{block}
}

\frame
{
  \frametitle{La régle des 5 en action}
  \only<1>{\sourcecodecpplines{code/rule5.cpp}{1}{17}}
  \only<2>{\sourcecodecpplines{code/rule5.cpp}{18}{35}}  
}

\frame
{
  \frametitle{La règles du 0}
  \begin{block}{Principes}
  \begin{itemize}
  \item Application du Single Responsability Principle
  \item Séparation entre classe métier et ressource
  \item Au final, rien à écrire
  \end{itemize}
  \end{block}{}

  \begin{block}{Mise en pratique}
  \begin{itemize}
  \item Conteneurs
  \item Pointeurs à sémantique Riche
  \item Autres classes standards de ressources systèmes
  \end{itemize}
  \end{block}{}
}

\frame
{
  \frametitle{La régle des 5 en action}
  \only<1>{\sourcecodecpp{code/rule0.cpp}}
  \only<2>{\sourcecodecpp{code/proper.cpp}}
}

\frame
{
  \frametitle{Pointeurs à sémantique riche}
  \begin{block}{Principes}
  \begin{itemize}
  \item Les pointeurs nus sont peu expressifs
  \item Emballage RAII de la gestion mémoire
  \item Pointeur nu = pointeur d'observation
  \end{itemize}
  \end{block}{}

  \begin{block}{Outils à disposition}
  \begin{itemize}
  \item Sémantique de propriété : \texttt{unique\_ptr}
  \item Sémantique de partage : \texttt{shared\_ptr} 
  \item Sémantique de partage faible: \texttt{weak\_ptr}
  \end{itemize}
  \end{block}{}
}

\frame
{
  \frametitle{\texttt{unique\_ptr}}
  \only<1>{
    \begin{block}{Principes}
  \begin{itemize}
  \item Pointeur à propriétaire unique
  \item Ne peut être copié mis seulement transféré
  \item Transfert = Transfert de propriété
  \end{itemize}
  \end{block}
  }
  \only<2>{
  \begin{block}{Mise en \oe{uvre}}
   \sourcecodecpp{code/raii/unique_ptr.cpp}
  \end{block}
  }
}

\frame
{
  \frametitle{\texttt{shared\_ptr}}
  \only<1>{
  \begin{block}{Principes}
  \begin{itemize}
  \item Pointeur à compteur de références
  \item Libère la mémoire lorsque aucune référence pointe sur lui
  \item Cycles gérés par \texttt{weak\_ptr}
  \end{itemize}
  \end{block}
  }
  \only<2>{\sourcecodecpp{code/raii/shared_ptr.cpp}}
  \only<3>{\sourcecodecpp{code/raii/weak_ptr.cpp}}
}

\end{document}
